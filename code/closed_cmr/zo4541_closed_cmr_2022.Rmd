---
title: "Closed CMR simulations"
author: "Deon Roos"
date: "Script last run on `r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    highlight: monochrome
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged
---

```{r, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
```

# Closed CMR data

Important highlights of closed CMR models:

* The aim is to estimate population size.

* The number of animals that were caught _is_ known.

* The objective is therefore to estimate the number of animals not caught (called `f0` in `MARK`).

# Details of the data collection

In 1965 an island wide capture-mark-recapture trapping session occurred across Amami island in a selection of sites known to have Amami rabbits present.

# 1965

```{r}
# Set seed so that the random numbers are the same each time you run the script
set.seed(666)

# total number of rabbits
N <- 674

# number of days of trapping
t <- 3

# capture probabilities (must be same length as number of days)
p <- c(0.17, 0.34, 0.48)

# create empty matrix
cap <- matrix(nrow = N, ncol = t, data = NA)

# see how many rabbits are actually captured on each day
# Based on binomial distribution with probability p[day], do this for all rabbits (N) where there is only a single day to capture (1)
cap[,1] <- rbinom(N, 1, p[1])
cap[,2] <- rbinom(N, 1, p[2])
cap[,3] <- rbinom(N, 1, p[3])

# Combine and store it in a dataframe
cap1965 <- data.frame(
  CH = paste(cap[,1], cap[,2], cap[,3])
)

# Turn it into a frequency table
cap1965 <- cap1965 %>% 
  count(CH, sort = T)

# Remove rabbits never caught (this is what students are trying to estimate)
cap1965 <- cap1965[cap1965$CH != "0 0 0",]

# Adding comments for students

cap1965$comment <- NA

for(i in 1:nrow(cap1965)){
  if(cap1965$CH[i] == "1 1 1"){
    cap1965$comment[i] <- "/* Number of rabbits caught on day 1, 2, 3 */"
  } else if(cap1965$CH[i] == "1 1 0") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 1, 2 */"
  } else if(cap1965$CH[i] == "0 1 1") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 2, 3 */"
  } else if(cap1965$CH[i] == "1 0 1") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 1, 3 */"
  } else if(cap1965$CH[i] == "1 0 0") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 1 */"
  } else if(cap1965$CH[i] == "0 1 0") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 2 */"
  } else if(cap1965$CH[i] == "0 0 1") {
    cap1965$comment[i] <- "/* Number of rabbits caught on day 3 */"
  }
}

# Final data looks like:
cap1965[,c(3, 1, 2)]
```

```{r}
library(ggplot2)

ggplot(cap1965) +
  geom_col(aes(x = reorder(CH, -n), y = n)) +
  labs(x = "Capture history (day1 | day2 | day3)",
       y = "Number of unique rabbits caught",
       title = "Amami rabbit capture histories in 1965",
       caption = paste("Total number of rabbits caught =", sum(as.numeric(cap1965$n)), "\n",
                       "Total number of rabbits =", N, "\n",
                       "f0 =", N - sum(as.numeric(cap1965$n)))) +
  theme_bw() +
  theme_minimal()
```

# 1983

```{r}
# Set seed so that the random numbers are the same each time you run the script
set.seed(666)

# total number of rabbits
N <- 421

# number of days of trapping
t <- 3

# capture probabilities (must be same length as number of days)
p <- c(0.07, 0.24, 0.38)

# recapture probability (must be of length t - 1)
pr <- c(0.64, 0.87)

# create empty matrix
cap <- matrix(nrow = N, ncol = t, data = NA)

# see how many rabbits are actually captured on each day
# Based on binomial distribution with probability p[day], do this for all rabbits (N) where there is only a single day to capture (1)
cap[,1] <- rbinom(N, 1, p[1])
for(i in 1:nrow(cap)){
  cap[i,2] <- ifelse(cap[i,1] == 0, rbinom(N, 1, p[2]), rbinom(N, 1, pr[1]))
}
for(i in 1:nrow(cap)){
  cap[i,3] <- ifelse(cap[i,1] == 0 & cap[i,2] == 0, rbinom(N, 1, p[3]), rbinom(N, 1, pr[2]))
}

# Combine and store it in a dataframe
cap1983 <- data.frame(
  CH = paste(cap[,1], cap[,2], cap[,3])
)

# Turn it into a frequency table
cap1983 <- cap1983 %>% 
  count(CH, sort = T)

# Remove rabbits never caught (this is what students are trying to estimate)
cap1983 <- cap1983[cap1983$CH != "0 0 0",]

# Adding comments for students

cap1983$comment <- NA

for(i in 1:nrow(cap1983)){
  if(cap1983$CH[i] == "1 1 1"){
    cap1983$comment[i] <- "/* Number of rabbits caught on day 1, 2, 3 */"
  } else if(cap1983$CH[i] == "1 1 0") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 1, 2 */"
  } else if(cap1983$CH[i] == "0 1 1") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 2, 3 */"
  } else if(cap1983$CH[i] == "1 0 1") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 1, 3 */"
  } else if(cap1983$CH[i] == "1 0 0") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 1 */"
  } else if(cap1983$CH[i] == "0 1 0") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 2 */"
  } else if(cap1983$CH[i] == "0 0 1") {
    cap1983$comment[i] <- "/* Number of rabbits caught on day 3 */"
  }
}

# Final data looks like:
cap1983[,c(3, 1, 2)]
```

```{r}
library(ggplot2)

ggplot(cap1983) +
  geom_col(aes(x = reorder(CH, -n), y = n)) +
  labs(x = "Capture history (day1 | day2 | day3)",
       y = "Number of unique rabbits caught",
       title = "Amami rabbit capture histories in 1983",
       caption = paste("Total number of rabbits caught =", sum(as.numeric(cap1983$n)), "\n",
                       "Total number of rabbits =", N, "\n",
                       "f0 =", N - sum(as.numeric(cap1983$n)))) +
  theme_bw() +
  theme_minimal()
```

# 2021 juveniles

Total 2021 population size = 80 juvenile, 60 subadult and 100 adults

```{r}
# Set seed so that the random numbers are the same each time you run the script
set.seed(666)

# total number of rabbits
N <- 83

# number of days of trapping
t <- 3

# capture probabilities (must be same length as number of days)
p <- c(0.36, 0.36, 0.36)

# recapture probability (must be of length t - 1)
pr <- c(0.42, 0.54)

# create empty matrix
cap <- matrix(nrow = N, ncol = t, data = NA)

# see how many rabbits are actually captured on each day
# Based on binomial distribution with probability p[day], do this for all rabbits (N) where there is only a single day to capture (1)
cap[,1] <- rbinom(N, 1, p[1])
for(i in 1:nrow(cap)){
  cap[i,2] <- ifelse(cap[i,1] == 0, rbinom(N, 1, p[2]), rbinom(N, 1, pr[1]))
}
for(i in 1:nrow(cap)){
  cap[i,3] <- ifelse(cap[i,1] == 0 & cap[i,2] == 0, rbinom(N, 1, p[3]), rbinom(N, 1, pr[2]))
}

# Combine and store it in a dataframe
cap2021_juv <- data.frame(
  CH = paste(cap[,1], cap[,2], cap[,3])
)

# Turn it into a frequency table
cap2021_juv <- cap2021_juv %>% 
  count(CH, sort = T)

# Remove rabbits never caught (this is what students are trying to estimate)
cap2021_juv <- cap2021_juv[cap2021_juv$CH != "0 0 0",]

# Adding comments for students

cap2021_juv$comment <- NA

for(i in 1:nrow(cap2021_juv)){
  if(cap2021_juv$CH[i] == "1 1 1"){
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 1, 2, 3 */"
  } else if(cap2021_juv$CH[i] == "1 1 0") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 1, 2 */"
  } else if(cap2021_juv$CH[i] == "0 1 1") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 2, 3 */"
  } else if(cap2021_juv$CH[i] == "1 0 1") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 1, 3 */"
  } else if(cap2021_juv$CH[i] == "1 0 0") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 1 */"
  } else if(cap2021_juv$CH[i] == "0 1 0") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 2 */"
  } else if(cap2021_juv$CH[i] == "0 0 1") {
    cap2021_juv$comment[i] <- "/* Number of rabbits caught on day 3 */"
  }
}

# Final data looks like:
cap2021_juv[,c(3, 1, 2)]
```

```{r}
library(ggplot2)

ggplot(cap2021_juv) +
  geom_col(aes(x = reorder(CH, -n), y = n)) +
  labs(x = "Capture history (day1 | day2 | day3)",
       y = "Number of unique juvenile rabbits caught",
       title = "Juvenile Amami rabbit capture histories in 2021",
       caption = paste("Total number of rabbits caught =", sum(as.numeric(cap2021_juv$n)), "\n",
                       "Total number of rabbits =", N, "\n",
                       "f0 =", N - sum(as.numeric(cap2021_juv$n)))) +
  theme_bw() +
  theme_minimal()
```

# 2021 subadults

Total 2021 population size = 80 juvenile, 60 subadult and 100 adults

```{r}
# Set seed so that the random numbers are the same each time you run the script
set.seed(666)

# total number of rabbits
N <- 59

# number of t of trapping
t <- 3

# capture probabilities (must be same length as number of t)
p <- c(0.46, 0.23, 0.13)

# recapture probability (must be of length t - 1)
pr <- c(0.39, 0.48)

# create empty matrix
cap <- matrix(nrow = N, ncol = t, data = NA)

# see how many rabbits are actually captured on each day
# Based on binomial distribution with probability p[day], do this for all rabbits (N) where there is only a single day to capture (1)
cap[,1] <- rbinom(N, 1, p[1])
for(i in 1:nrow(cap)){
  cap[i,2] <- ifelse(cap[i,1] == 0, rbinom(N, 1, p[2]), rbinom(N, 1, pr[1]))
}
for(i in 1:nrow(cap)){
  cap[i,3] <- ifelse(cap[i,1] == 0 & cap[i,2] == 0, rbinom(N, 1, p[3]), rbinom(N, 1, pr[2]))
}

# Combine and store it in a dataframe
cap2021_suba <- data.frame(
  CH = paste(cap[,1], cap[,2], cap[,3])
)

# Turn it into a frequency table
cap2021_suba <- cap2021_suba %>% 
  count(CH, sort = T)

# Remove rabbits never caught (this is what students are trying to estimate)
cap2021_suba <- cap2021_suba[cap2021_suba$CH != "0 0 0",]

# Adding comments for students

cap2021_suba$comment <- NA

for(i in 1:nrow(cap2021_juv)){
  if(cap2021_suba$CH[i] == "1 1 1"){
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 1, 2, 3 */"
  } else if(cap2021_suba$CH[i] == "1 1 0") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 1, 2 */"
  } else if(cap2021_suba$CH[i] == "0 1 1") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 2, 3 */"
  } else if(cap2021_suba$CH[i] == "1 0 1") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 1, 3 */"
  } else if(cap2021_suba$CH[i] == "1 0 0") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 1 */"
  } else if(cap2021_suba$CH[i] == "0 1 0") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 2 */"
  } else if(cap2021_suba$CH[i] == "0 0 1") {
    cap2021_suba$comment[i] <- "/* Number of rabbits caught on day 3 */"
  }
}

# Final data looks like:
cap2021_suba[,c(3, 1, 2)]
```

```{r}
library(ggplot2)

ggplot(cap2021_suba) +
  geom_col(aes(x = reorder(CH, -n), y = n)) +
  labs(x = "Capture history (day1 | day2 | day3)",
       y = "Number of unique subadult rabbits caught",
       title = "Subadult Amami rabbit capture histories in 2021",
       caption = paste("Total number of rabbits caught =", sum(as.numeric(cap2021_suba$n)), "\n",
                       "Total number of rabbits =", N, "\n",
                       "f0 =", N - sum(as.numeric(cap2021_suba$n)))) +
  theme_bw() +
  theme_minimal()
```

# 2021 subadults

Total 2021 population size = 80 juvenile, 60 subadult and 100 adults

```{r}
# Set seed so that the random numbers are the same each time you run the script
set.seed(666)

# total number of rabbits
N <- 106

# number of days of trapping
t <- 3

# capture probabilities (must be same length as number of days)
p <- c(0.26, 0.38, 0.43)

# recapture probability (must be of length t - 1)
pr <- c(0.56, 0.56)

# create empty matrix
cap <- matrix(nrow = N, ncol = t, data = NA)

# see how many rabbits are actually captured on each day
# Based on binomial distribution with probability p[day], do this for all rabbits (N) where there is only a single day to capture (1)
cap[,1] <- rbinom(N, 1, p[1])
for(i in 1:nrow(cap)){
  cap[i,2] <- ifelse(cap[i,1] == 0, rbinom(N, 1, p[2]), rbinom(N, 1, pr[1]))
}
for(i in 1:nrow(cap)){
  cap[i,3] <- ifelse(cap[i,1] == 0 & cap[i,2] == 0, rbinom(N, 1, p[3]), rbinom(N, 1, pr[2]))
}

# Combine and store it in a dataframe
cap2021_adult <- data.frame(
  CH = paste(cap[,1], cap[,2], cap[,3])
)

# Turn it into a frequency table
cap2021_adult <- cap2021_adult %>% 
  count(CH, sort = T)

# Remove rabbits never caught (this is what students are trying to estimate)
cap2021_adult <- cap2021_adult[cap2021_adult$CH != "0 0 0",]

# Adding comments for students

cap2021_adult$comment <- NA

for(i in 1:nrow(cap2021_juv)){
  if(cap2021_adult$CH[i] == "1 1 1"){
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 1, 2, 3 */"
  } else if(cap2021_adult$CH[i] == "1 1 0") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 1, 2 */"
  } else if(cap2021_adult$CH[i] == "0 1 1") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 2, 3 */"
  } else if(cap2021_adult$CH[i] == "1 0 1") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 1, 3 */"
  } else if(cap2021_adult$CH[i] == "1 0 0") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 1 */"
  } else if(cap2021_adult$CH[i] == "0 1 0") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 2 */"
  } else if(cap2021_adult$CH[i] == "0 0 1") {
    cap2021_adult$comment[i] <- "/* Number of rabbits caught on day 3 */"
  }
}

# Final data looks like:
cap2021_adult[,c(3, 1, 2)]
```

```{r}
library(ggplot2)

ggplot(cap2021_adult) +
  geom_col(aes(x = reorder(CH, -n), y = n)) +
  labs(x = "Capture history (day1 | day2 | day3)",
       y = "Number of unique adult rabbits caught",
       title = "Adult Amami rabbit capture histories in 2021",
       caption = paste("Total number of rabbits caught =", sum(as.numeric(cap2021_adult$n)), "\n",
                       "Total number of rabbits =", N, "\n",
                       "f0 =", N - sum(as.numeric(cap2021_adult$n)))) +
  theme_bw() +
  theme_minimal()
```